<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SpringTweet - Pesquisa de Tweets</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fffefef3;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #0f0f0fad;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        h1 {
            margin: 0;
            font-size: 2em;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        input, button {
            font-size: 16px;
            padding: 10px;
            margin: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #0f0f0fad;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1c1c1cf5;
        }
        .tweet-card {
            border: 1px solid #ccc;
            background-color: #fafafa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px auto;
            text-align: left;
            width: 90%;
        }
        .tweet-meta {
            color: #555;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            width: 300px;
        }
        .modal input {
            width: 90%;
            margin: 5px 0;
            padding: 5px;
        }
        footer {
            margin-top: 40px;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Pesquisar Tweets</h1>
    </header>

    <div class="container">
        <div id="topButtons">
            <button onclick="goIndex()">Voltar para Início</button>
            <button onclick="goCreate()">Criar Tweet</button>
        </div>

        <h3>Buscar Tweet por ID</h3>
        <input type="number" id="tweetId" placeholder="ID do Tweet">
        <button onclick="getTweetById()">Buscar</button>

        <h3>Listar Todos os Tweets</h3>
        <button onclick="getAllTweets()">Listar Todos</button>

        <h2>Resultado:</h2>
        <div id="result"></div>
    </div>

    <div class="modal" id="authModal">
        <div class="modal-content">
            <h3>Autenticação necessária</h3>
            <input type="number" id="authId" placeholder="Seu ID"><br>
            <input type="password" id="authPassword" placeholder="Sua senha"><br>
            <div style="margin-top:10px;">
                <button onclick="confirmDeleteAuth()">Confirmar</button>
                <button onclick="closeAuthModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8080/api/tweets";
        const USERS_API = "http://localhost:8080/api/users";
        let pendingDeleteTweetId = null;

        function goIndex() { window.location.href = "index.html"; }
        function goCreate(){ window.location.href = "createTweet.html"; }

        async function getTweetById() {
            const id = document.getElementById("tweetId").value;
            if (!id) return alert("Informe o ID do tweet");
            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (!response.ok) throw new Error("Tweet não encontrado");
                const tweet = await response.json();
                showTweets([tweet]);
            } catch (error) {
                document.getElementById("result").innerHTML = `<p style="color:red;">${error.message}</p>`;
            }
        }

        async function getAllTweets() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Erro ao listar tweets");
                const tweets = await response.json();
                showTweets(tweets);
            } catch (error) {
                document.getElementById("result").innerHTML = `<p style="color:red;">${error.message}</p>`;
            }
        }

        function showTweets(tweets) {
            const container = document.getElementById("result");
            container.innerHTML = "";

            if (!Array.isArray(tweets) || tweets.length === 0) {
                container.innerHTML = "<p>Nenhum tweet encontrado.</p>";
                return;
            }

            tweets.forEach(tweet => {
                const postTime = tweet.postTime ? tweet.postTime.replace("T", " ").slice(0, 19) : "Desconhecido";
                const userName = tweet.user ? tweet.user.screenName : "Desconhecido";
                const userId = tweet.user ? tweet.user.userId : "Desconhecido";

                const div = document.createElement("div");
                div.className = "tweet-card";
                div.innerHTML = `
                    <div class="tweet-meta">
                        <strong>ID:</strong> ${tweet.id} &nbsp;
                        <strong>Usuário:</strong> ${userName} (ID: ${userId}) &nbsp;
                        <strong>Postado em:</strong> ${postTime}
                    </div>
                    <div><strong>Conteúdo:</strong><br>${escapeHtml(tweet.content)}</div>
                    <div style="margin-top:10px; text-align:right;">
                        <button onclick="openUpdate(${tweet.id})">Atualizar</button>
                        <button onclick="openDeleteAuth(${tweet.id})">Excluir</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function openUpdate(tweetId) {
            window.location.href = `updateTweet.html?id=${tweetId}`;
        }

        function openDeleteAuth(tweetId) {
            pendingDeleteTweetId = tweetId;
            document.getElementById("authId").value = "";
            document.getElementById("authPassword").value = "";
            document.getElementById("authModal").style.display = "flex";
        }

        function closeAuthModal() {
            document.getElementById("authModal").style.display = "none";
        }

        async function confirmDeleteAuth() {
            const authId = document.getElementById("authId").value.trim();
            const password = document.getElementById("authPassword").value.trim();

            if (!authId || !password) {
                alert("Preencha ID e senha para autenticar.");
                return;
            }

            if (!pendingDeleteTweetId) {
                alert("Nenhum tweet selecionado para deletar.");
                return;
            }

            closeAuthModal();

            try {
                const userResp = await fetch(`${USERS_API}/${authId}`);
                if (!userResp.ok) throw new Error("Usuário autenticador não encontrado.");
                const authUser = await userResp.json();

                if (authUser.password !== password)
                    throw new Error("Senha incorreta.");

                const tweetResp = await fetch(`${API_URL}/${pendingDeleteTweetId}`);
                if (!tweetResp.ok) throw new Error("Tweet não encontrado.");
                const tweet = await tweetResp.json();
                const ownerId = tweet.user ? tweet.user.userId : null;

                const isAdmin = authUser.role && authUser.role.toUpperCase() === "ADMIN";
                if (!isAdmin && String(authUser.userId) !== String(ownerId))
                    throw new Error("Você não tem permissão para deletar este tweet.");

                const delResp = await fetch(`${API_URL}/${pendingDeleteTweetId}/delete/${authUser.userId}`, {
                    method: "DELETE"
                });
                if (!delResp.ok) throw new Error("Erro ao deletar tweet.");

                alert("Tweet excluído com sucesso!");
                getAllTweets();
            } catch (error) {
                alert(error.message);
            } finally {
                pendingDeleteTweetId = null;
            }
        }
    </script>
</body>
</html>
