<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Spring Tweet - Pesquisa de Usuários</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fffefef3;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #0f0f0fad;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        h1 {
            margin: 0;
            font-size: 2em;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        input, button {
            font-size: 16px;
            padding: 10px;
            margin: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #0f0f0fad;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1c1c1cf5;
        }
        #result div {
            border: 1px solid #ccc;
            background-color: #fafafa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px auto;
            text-align: left;
            width: 90%;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            width: 300px;
        }
        .modal input {
            width: 90%;
            margin: 5px 0;
            padding: 5px;
        }
        footer {
            margin-top: 40px;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Pesquisar Usuários</h1>
    </header>

    <div class="container">
        <button onclick="goBack()">Voltar para tela inicial</button>

        <h3>Buscar usuário por ID</h3>
        <input type="number" id="userId" placeholder="ID do usuário">
        <button onclick="getUserById()">Buscar</button>

        <h3>Listar todos os usuários (somente administradores)</h3>
        <button onclick="openAuthModal('list')">Listar Todos</button>

        <div id="result"></div>
    </div>

    <div class="modal" id="authModal">
        <div class="modal-content">
            <h3>Autenticação</h3>
            <input type="number" id="authId" placeholder="ID do usuário"><br>
            <input type="password" id="authPassword" placeholder="Senha"><br>
            <button onclick="confirmAuth()">Confirmar</button>
            <button onclick="closeAuthModal()">Cancelar</button>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8080/api/users";
        let actionType = null;
        let targetUserId = null;
        let lastAdminId = null;

        function goBack() {
            window.location.href = "index.html";
        }

        function openAuthModal(action, targetId = null) {
            actionType = action;
            targetUserId = targetId;
            document.getElementById("authId").value = "";
            document.getElementById("authPassword").value = "";
            document.getElementById("authModal").style.display = "flex";
        }

        function closeAuthModal() {
            document.getElementById("authModal").style.display = "none";
        }

        async function confirmAuth() {
            const userId = document.getElementById("authId").value.trim();
            const password = document.getElementById("authPassword").value.trim();
            closeAuthModal();

            if (!userId || !password) {
                alert("ID e senha são obrigatórios");
                return;
            }

            try {
                const response = await fetch(`${API_URL}/${userId}`);
                if (!response.ok) throw new Error("Usuário não encontrado");
                const authUser = await response.json();

                if (authUser.password !== password) throw new Error("Senha incorreta");

                if (actionType === "list") {
                    if (authUser.role.toUpperCase() !== "ADMIN") throw new Error("Apenas administradores podem listar todos os usuários");
                    lastAdminId = authUser.userId;
                    await listAll(authUser.userId);
                } else if (actionType === "delete") {
                    await deleteUser(authUser, targetUserId);
                }
            } catch (error) {
                document.getElementById("result").innerHTML =
                    `<p style="color:red;">${error.message}</p>`;
            }
        }

        async function getUserById() {
            const id = document.getElementById("userId").value;
            if (!id) return alert("Informe o ID");

            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (!response.ok) throw new Error("Usuário não encontrado");
                const user = await response.json();
                showUsers([user]);
            } catch (e) {
                document.getElementById("result").innerHTML =
                    `<p style="color:red;">${e.message}</p>`;
            }
        }

        async function listAll(userId) {
            try {
                const response = await fetch(`${API_URL}/all/${userId}`);
                if (!response.ok) throw new Error("Erro ao buscar usuários");
                const users = await response.json();
                showUsers(users);
            } catch (e) {
                document.getElementById("result").innerHTML =
                    `<p style="color:red;">${e.message}</p>`;
            }
        }

        function showUsers(users) {
            const container = document.getElementById("result");
            container.innerHTML = "";

            users.forEach(user => {
                const div = document.createElement("div");
                div.innerHTML = `
                    <strong>ID:</strong> ${user.userId}<br>
                    <strong>Nome:</strong> ${user.screenName}<br>
                    <strong>Bio:</strong> ${user.bio || "(sem bio)"}<br>
                    <strong>Função:</strong> ${user.role}<br><br>
                    <button onclick="openUpdate(${user.userId})">Atualizar</button>
                    <button onclick="openAuthModal('delete', ${user.userId})">Excluir</button>
                `;
                container.appendChild(div);
            });
        }

        function openUpdate(userId) {
            window.location.href = `updateUser.html?id=${userId}`;
        }

        async function deleteUser(authUser, targetId) {
            if (authUser.role.toUpperCase() !== "ADMIN" && authUser.userId != targetId)
                throw new Error("Você não tem permissão para deletar este usuário");

            try {
                const response = await fetch(`${API_URL}/${authUser.userId}/delete/${targetId}`, {
                    method: "DELETE"
                });
                if (!response.ok) throw new Error("Erro ao deletar o usuário");

                alert("Usuário deletado com sucesso!");
                if (authUser.role.toUpperCase() === "ADMIN" && lastAdminId)
                    await listAll(lastAdminId);
                else
                    document.getElementById("result").innerHTML = `<p style="color:green;">Usuário deletado com sucesso!</p>`;
            } catch (error) {
                document.getElementById("result").innerHTML = `<p style="color:red;">${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
